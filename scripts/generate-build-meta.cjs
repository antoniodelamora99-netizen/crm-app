#!/usr/bin/env node
const { execSync } = require('child_process');
const { writeFileSync, mkdirSync, existsSync } = require('fs');
const path = require('path');

function run(cmd) {
  try { return execSync(cmd, { stdio: ['ignore','pipe','ignore'] }).toString().trim(); } catch { return 'unknown'; }
}

const full = run('git rev-parse HEAD');
const short = full.substring(0,7);
const dateIso = new Date().toISOString();

const outDir = path.join(__dirname, '..', 'src', 'lib');
if (!existsSync(outDir)) mkdirSync(outDir, { recursive: true });

const file = `// AUTO-GENERATED by scripts/generate-build-meta.cjs\nexport const BUILD_COMMIT = '${full}';\nexport const BUILD_COMMIT_SHORT = '${short}';\nexport const BUILD_DATE_ISO = '${dateIso}';\n`;

writeFileSync(path.join(outDir, 'buildMeta.ts'), file, 'utf8');
console.log('Build meta generated:', short, dateIso);
